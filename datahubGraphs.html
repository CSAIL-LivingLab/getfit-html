<html>

<head>
    <title>Sample DataHub HTML</title>
    <script type="text/javascript" src="https://datahub.csail.mit.edu/static/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="https://datahub.csail.mit.edu/static/lib/thrift/thrift.js"></script>
    <script type="text/javascript" src="https://datahub.csail.mit.edu/static/lib/datahub/datahub_types.js"></script>
    <script type="text/javascript" src="https://datahub.csail.mit.edu/static/lib/datahub/DataHub.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
    google.load("visualization", "1", {
        packages: ["corechart", "table", "timeline", "map"]
    });
    </script>

    <style>
    h2 {
        text-align: center;
        margin-bottom: 0;
        font-family: "Helvetica Neue";
        font-weight: lighter;
        color: gray;
    }
    ,
    #google-visulization-errors-0 {
        display: none;
    }
    </style>
</head>

<body>
    <div style="height:40px">
    </div>
    <div>
        <h2>Minutes by Week</h2>
        <div id="column-chart-div">
        </div>
    </div>
    <div>
        <h2>Activity Breakdown</h2>
        <div id="pie-chart-div">
        </div>
    </div>
    <div>
        <h2>Your Activities</h2>
        <div id="table-div">
        </div>
    </div>
    <div style="height:100px">
    </div>

</body>

</html>


<script type="text/javascript">
var app_id = "";
var app_token = "";
var repo_base = "";
var activity_results_arr = [];
var week_results_arr = [];

function makeCharts() {

    transport = new Thrift.Transport("https://datahub.csail.mit.edu/service/json"),
        protocol = new Thrift.Protocol(transport),
        client = new DataHubClient(protocol),
        con_params = new ConnectionParams({
            'app_id': app_id,
            'app_token': app_token,
            'repo_base': repo_base
        }),


        con = client.open_connection(con_params),

        // popular activities
        activity_res = client.execute_sql(con, 'select activity, sum(duration) from getfit.minutes GROUP BY activity order by sum desc');

    // minutes by week
    var firstDateStr = '2015-01-11';
    var weekQuery = "select week, minutes from (SELECT sum(duration) as minutes, TRUNC(DATE_PART('day', enddate - ' " + firstDateStr + "'::timestamp)/7) as week from getfit.minutes group by week) as numberedWeeks;"
    week_res = client.execute_sql(con, weekQuery);



    activity_results_arr = [];
    activity_results_arr.push(activity_res.field_names)
    $.each(activity_res.tuples, function(tuple_idx, tuple) {
        var cell_arr = []
        $.each(tuple.cells, function(cell_idx, cell) {
            var val = parseFloat(cell)
            cell_arr.push(isNaN(val) ? cell : val)
        });
        activity_results_arr.push(cell_arr)
    });


    week_results_arr = [];
    week_results_arr.push(week_res.field_names)
    $.each(week_res.tuples, function(tuple_idx, tuple) {
        var cell_arr = []
        $.each(tuple.cells, function(cell_idx, cell) {
            var val = parseFloat(cell)
            cell_arr.push(isNaN(val) ? cell : val)
        });
        week_results_arr.push(cell_arr)
    });

    // fill week_results_arr with blank data, or it will show an error
    if (week_results_arr.length == 1) {
        week_results_arr = [
            ["week_number", "minutes"],
            [0, 0]
        ];
    };

    
 


  // draw the column chart


    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
   var date = new Date(firstDateStr); 

    for (var i = 1; i < week_results_arr.length; i++) {
      var month = monthNames[date.getMonth()];
      var day = date.getDate();

      var newDateStr = month + " " + day;
      week_results_arr[i][0] = newDateStr;
      date.setDate(date.getDate()+7);
    };

    
   
    var column_chart = new google.visualization.ColumnChart(document.getElementById('column-chart-div'));
    var column_count = week_results_arr.length-1;
    var column_chart_options = {
        legend: {
            position: 'none'
        },
        hAxis: {
            title: 'Week',
            gridlines: {
                count: column_count
            },
            format: 0,

        },
        vAxis: {
            title: 'Minutes'
        }
    };

    week_data = google.visualization.arrayToDataTable(week_results_arr);
    column_chart.draw(week_data, column_chart_options);


    // draw the pie chart
    activity_data = google.visualization.arrayToDataTable(activity_results_arr);
    var pie_chart = new google.visualization.PieChart(document.getElementById('pie-chart-div'));
    pie_chart.draw(activity_data, {});

    // draw the table
    var table = new google.visualization.Table(document.getElementById('table-div'));
    table.draw(activity_data);

}
</script>
